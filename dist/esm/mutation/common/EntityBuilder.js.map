{"version":3,"file":"EntityBuilder.js","sources":["../../../../src/mutation/common/EntityBuilder.ts"],"sourcesContent":["import type {\n  AttachRelationDefinition,\n  Attributes,\n  BuildOnly,\n  CreateEntityAttributes,\n  CreateRelationParams,\n  CreateRelationResult,\n  DetachRelationDefinition,\n  ExtractModelAttributes,\n  IEntityBuilder,\n  IRelationBuilder,\n  MutationFunction,\n  MutationRequest,\n  MutationResponse,\n  SimpleKey,\n  SyncParams,\n  SyncRelationDefinition,\n  ToggleParams,\n  ToggleRelationDefinition,\n  TypedMutationOperation,\n  UpdateRelationParams,\n  UpdateRelationResult,\n} from \"@/mutation/types\";\nimport type { RequestConfig } from \"@/http/types\";\nimport { RelationBuilder } from \"@/mutation/common/RelationBuilder\";\n\nexport class EntityBuilder<TModel>\n  extends RelationBuilder\n  implements IEntityBuilder<TModel>, BuildOnly<TModel> {\n  private operations: Array<TypedMutationOperation<TModel, any>> = [];\n  private mutationFn: MutationFunction | null = null;\n  private relationBuilder: IRelationBuilder;\n\n  constructor (relationBuilder: IRelationBuilder) {\n    super();\n    this.relationBuilder = relationBuilder;\n  }\n\n  private extractOperationData<T extends Record<string, unknown>>(\n    attributes: T,\n  ): {\n    normalAttributes: Record<string, unknown>;\n    relations: Record<string, unknown>;\n  } {\n    const normalAttributes: Record<string, unknown> = {};\n    const relations: Record<string, unknown> = {};\n\n    for (const [key, value] of Object.entries(attributes)) {\n      if (value && typeof value === \"object\" && \"operation\" in value) {\n        relations[key] = value;\n      } else {\n        normalAttributes[key] = value;\n      }\n    }\n\n    return { normalAttributes, relations };\n  }\n\n  public setMutationFunction(fn: MutationFunction): void {\n    this.mutationFn = fn;\n  }\n\n  public createEntity<\n    T extends Record<string, unknown>,\n    TRelationKeys extends keyof T = never,\n  >(\n    attributes: CreateEntityAttributes<T, TRelationKeys>,\n  ): BuildOnly<TModel, Pick<T, Extract<TRelationKeys, string>>> {\n    const { normalAttributes, relations } =\n      this.extractOperationData(attributes);\n\n    const operation: TypedMutationOperation<TModel, typeof relations> = {\n      operation: \"create\",\n      attributes: normalAttributes as ExtractModelAttributes<TModel>,\n      relations,\n    };\n\n    this.operations.push(operation);\n    return this as unknown as BuildOnly<\n      TModel,\n      Pick<T, Extract<TRelationKeys, string>>\n    >;\n  }\n\n  public updateEntity<T extends Record<string, unknown>>(\n    key: string | number,\n    attributes: T,\n  ): IEntityBuilder<TModel> {\n    const { normalAttributes, relations } =\n      this.extractOperationData(attributes);\n\n    const operation: TypedMutationOperation<TModel, typeof relations> = {\n      operation: \"update\",\n      key,\n      attributes: normalAttributes as ExtractModelAttributes<TModel>,\n      relations,\n    };\n\n    this.operations.push(operation);\n    return this;\n  }\n\n  public build(): MutationRequest<TModel, any> {\n    const result = [...this.operations];\n    this.operations = [];\n    return { mutate: result };\n  }\n\n  public async mutate(\n    options?: Partial<RequestConfig>,\n  ): Promise<MutationResponse> {\n    if (!this.mutationFn) {\n      throw new Error(\"Mutation function not provided to builder\");\n    }\n\n    const data = this.build();\n    return this.mutationFn(data, options);\n  }\n\n  public override createRelation<\n    T extends Attributes,\n    TRelationKeys extends keyof T = never,\n  >(\n    params: CreateRelationParams<T, TRelationKeys>\n  ): CreateRelationResult<T, TRelationKeys> {\n    const { attributes, relations } = params;\n    return this.relationBuilder.createRelation<T, TRelationKeys>({\n      attributes,\n      relations,\n    });\n  }\n\n  public override updateRelation<\n    T extends Attributes,\n    TRelationKeys extends keyof T = never,\n  >(\n    params: UpdateRelationParams<T, TRelationKeys>\n  ): UpdateRelationResult<T, TRelationKeys> {\n    const { key, attributes, relations } = params;\n    return this.relationBuilder.updateRelation<T, TRelationKeys>({\n      key,\n      attributes,\n      relations,\n    });\n  }\n\n  public override attach(key: SimpleKey): AttachRelationDefinition {\n    return this.relationBuilder.attach(key);\n  }\n\n  public override detach(key: SimpleKey): DetachRelationDefinition {\n    return this.relationBuilder.detach(key);\n  }\n\n  public override sync<T>(\n    params: SyncParams<T>\n  ): SyncRelationDefinition<T> {\n    const { key, attributes, pivot, withoutDetaching } = params;\n    return this.relationBuilder.sync<T>({\n      key,\n      attributes,\n      pivot,\n      withoutDetaching,\n    });\n  }\n\n  public override toggle<T>(\n    params: ToggleParams<T>\n  ): ToggleRelationDefinition<T> {\n    const { key, attributes, pivot } = params;\n    return this.relationBuilder.toggle<T>({\n      key,\n      attributes,\n      pivot,\n    });\n  };\n}\n"],"names":[],"mappings":";;;;AA0BO,MAAM,sBACH,gBAC6C;AAAA,EAKrD,YAAa,iBAAmC;AACxC,UAAA;AALA,sCAAyD,CAAC;AAC1D,sCAAsC;AACtC;AAIN,SAAK,kBAAkB;AAAA,EAAA;AAAA,EAGjB,qBACN,YAIA;AACA,UAAM,mBAA4C,CAAC;AACnD,UAAM,YAAqC,CAAC;AAE5C,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,UAAU,GAAG;AACrD,UAAI,SAAS,OAAO,UAAU,YAAY,eAAe,OAAO;AAC9D,kBAAU,GAAG,IAAI;AAAA,MAAA,OACZ;AACL,yBAAiB,GAAG,IAAI;AAAA,MAAA;AAAA,IAC1B;AAGK,WAAA,EAAE,kBAAkB,UAAU;AAAA,EAAA;AAAA,EAGhC,oBAAoB,IAA4B;AACrD,SAAK,aAAa;AAAA,EAAA;AAAA,EAGb,aAIL,YAC4D;AAC5D,UAAM,EAAE,kBAAkB,UAAA,IACxB,KAAK,qBAAqB,UAAU;AAEtC,UAAM,YAA8D;AAAA,MAClE,WAAW;AAAA,MACX,YAAY;AAAA,MACZ;AAAA,IACF;AAEK,SAAA,WAAW,KAAK,SAAS;AACvB,WAAA;AAAA,EAAA;AAAA,EAMF,aACL,KACA,YACwB;AACxB,UAAM,EAAE,kBAAkB,UAAA,IACxB,KAAK,qBAAqB,UAAU;AAEtC,UAAM,YAA8D;AAAA,MAClE,WAAW;AAAA,MACX;AAAA,MACA,YAAY;AAAA,MACZ;AAAA,IACF;AAEK,SAAA,WAAW,KAAK,SAAS;AACvB,WAAA;AAAA,EAAA;AAAA,EAGF,QAAsC;AAC3C,UAAM,SAAS,CAAC,GAAG,KAAK,UAAU;AAClC,SAAK,aAAa,CAAC;AACZ,WAAA,EAAE,QAAQ,OAAO;AAAA,EAAA;AAAA,EAG1B,MAAa,OACX,SAC2B;AACvB,QAAA,CAAC,KAAK,YAAY;AACd,YAAA,IAAI,MAAM,2CAA2C;AAAA,IAAA;AAGvD,UAAA,OAAO,KAAK,MAAM;AACjB,WAAA,KAAK,WAAW,MAAM,OAAO;AAAA,EAAA;AAAA,EAGtB,eAId,QACwC;AAClC,UAAA,EAAE,YAAY,UAAA,IAAc;AAC3B,WAAA,KAAK,gBAAgB,eAAiC;AAAA,MAC3D;AAAA,MACA;AAAA,IAAA,CACD;AAAA,EAAA;AAAA,EAGa,eAId,QACwC;AACxC,UAAM,EAAE,KAAK,YAAY,UAAc,IAAA;AAChC,WAAA,KAAK,gBAAgB,eAAiC;AAAA,MAC3D;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACD;AAAA,EAAA;AAAA,EAGa,OAAO,KAA0C;AACxD,WAAA,KAAK,gBAAgB,OAAO,GAAG;AAAA,EAAA;AAAA,EAGxB,OAAO,KAA0C;AACxD,WAAA,KAAK,gBAAgB,OAAO,GAAG;AAAA,EAAA;AAAA,EAGxB,KACd,QAC2B;AAC3B,UAAM,EAAE,KAAK,YAAY,OAAO,iBAAqB,IAAA;AAC9C,WAAA,KAAK,gBAAgB,KAAQ;AAAA,MAClC;AAAA,MACA;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACD;AAAA,EAAA;AAAA,EAGa,OACd,QAC6B;AAC7B,UAAM,EAAE,KAAK,YAAY,MAAU,IAAA;AAC5B,WAAA,KAAK,gBAAgB,OAAU;AAAA,MACpC;AAAA,MACA;AAAA,MACA;AAAA,IAAA,CACD;AAAA,EAAA;AAEL;"}