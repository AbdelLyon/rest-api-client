{"version":3,"file":"HttpRequest.js","sources":["../../../../src/http/shared/HttpRequest.ts"],"sourcesContent":["import type { RequestConfig } from \"@/http/types/http\";\n\nexport class HttpRequest {\n  static isRetryableError(status: number, method?: string): boolean {\n    const idempotentMethods = [\"GET\", \"HEAD\", \"OPTIONS\", \"PUT\", \"DELETE\"];\n    const isIdempotent =\n      !method || idempotentMethods.includes(method.toUpperCase());\n\n    return (\n      isIdempotent &&\n      (status === 0 || status === 429 || (status >= 500 && status < 600))\n    );\n  }\n\n  static async fetchWithRetry(\n    url: string,\n    config: RequestConfig,\n    maxRetries: number,\n    defaultTimeout: number,\n    withCredentials: boolean,\n    attempt: number = 1,\n  ): Promise<Response> {\n    try {\n      const {\n        timeout = defaultTimeout,\n        params,\n        data,\n        ...fetchOptions\n      } = config;\n      let fullUrl = url;\n\n      if (params && Object.keys(params).length > 0) {\n        const queryParams = new URLSearchParams();\n        for (const [key, value] of Object.entries(params)) {\n          queryParams.append(key, value);\n        }\n        fullUrl += `?${queryParams.toString()}`;\n      }\n\n      const controller = new AbortController();\n      const timeoutId = setTimeout(\n        () => controller.abort(\"Request timeout\"),\n        timeout,\n      );\n\n      let body: any = undefined;\n      if (data !== undefined) {\n        body = typeof data === \"string\" ? data : JSON.stringify(data);\n      }\n\n      const response = await fetch(fullUrl, {\n        ...fetchOptions,\n        body,\n        signal: controller.signal,\n        credentials: withCredentials ? \"include\" : \"same-origin\",\n      });\n\n      clearTimeout(timeoutId);\n\n      if (!response.ok) {\n        if (\n          attempt < maxRetries &&\n          this.isRetryableError(response.status, config.method)\n        ) {\n          const delay = Math.pow(2, attempt) * 100;\n          await new Promise((resolve) => setTimeout(resolve, delay));\n          return this.fetchWithRetry(\n            url,\n            config,\n            maxRetries,\n            defaultTimeout,\n            withCredentials,\n            attempt + 1,\n          );\n        }\n      }\n\n      return response;\n    } catch (error) {\n      if (error instanceof DOMException && error.name === \"AbortError\") {\n        throw new Error(\n          `Request timeout after ${config.timeout || defaultTimeout}ms`,\n        );\n      }\n\n      if (attempt < maxRetries && this.isRetryableError(0, config.method)) {\n        const delay = Math.pow(2, attempt) * 100;\n        await new Promise((resolve) => setTimeout(resolve, delay));\n        return this.fetchWithRetry(\n          url,\n          config,\n          maxRetries,\n          defaultTimeout,\n          withCredentials,\n          attempt + 1,\n        );\n      }\n\n      throw error;\n    }\n  }\n}\n"],"names":[],"mappings":"AAEO,MAAM,YAAY;AAAA,EACvB,OAAO,iBAAiB,QAAgB,QAA0B;AAChE,UAAM,oBAAoB,CAAC,OAAO,QAAQ,WAAW,OAAO,QAAQ;AACpE,UAAM,eACJ,CAAC,UAAU,kBAAkB,SAAS,OAAO,aAAa;AAE5D,WACE,iBACC,WAAW,KAAK,WAAW,OAAQ,UAAU,OAAO,SAAS;AAAA,EAAA;AAAA,EAIlE,aAAa,eACX,KACA,QACA,YACA,gBACA,iBACA,UAAkB,GACC;AACf,QAAA;AACI,YAAA;AAAA,QACJ,UAAU;AAAA,QACV;AAAA,QACA;AAAA,QACA,GAAG;AAAA,MAAA,IACD;AACJ,UAAI,UAAU;AAEd,UAAI,UAAU,OAAO,KAAK,MAAM,EAAE,SAAS,GAAG;AACtC,cAAA,cAAc,IAAI,gBAAgB;AACxC,mBAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,MAAM,GAAG;AACrC,sBAAA,OAAO,KAAK,KAAK;AAAA,QAAA;AAEpB,mBAAA,IAAI,YAAY,SAAU,CAAA;AAAA,MAAA;AAGjC,YAAA,aAAa,IAAI,gBAAgB;AACvC,YAAM,YAAY;AAAA,QAChB,MAAM,WAAW,MAAM,iBAAiB;AAAA,QACxC;AAAA,MACF;AAEA,UAAI,OAAY;AAChB,UAAI,SAAS,QAAW;AACtB,eAAO,OAAO,SAAS,WAAW,OAAO,KAAK,UAAU,IAAI;AAAA,MAAA;AAGxD,YAAA,WAAW,MAAM,MAAM,SAAS;AAAA,QACpC,GAAG;AAAA,QACH;AAAA,QACA,QAAQ,WAAW;AAAA,QACnB,aAAa,kBAAkB,YAAY;AAAA,MAAA,CAC5C;AAED,mBAAa,SAAS;AAElB,UAAA,CAAC,SAAS,IAAI;AAEd,YAAA,UAAU,cACV,KAAK,iBAAiB,SAAS,QAAQ,OAAO,MAAM,GACpD;AACA,gBAAM,QAAQ,KAAK,IAAI,GAAG,OAAO,IAAI;AACrC,gBAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,KAAK,CAAC;AACzD,iBAAO,KAAK;AAAA,YACV;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,YACA,UAAU;AAAA,UACZ;AAAA,QAAA;AAAA,MACF;AAGK,aAAA;AAAA,aACA,OAAO;AACd,UAAI,iBAAiB,gBAAgB,MAAM,SAAS,cAAc;AAChE,cAAM,IAAI;AAAA,UACR,yBAAyB,OAAO,WAAW,cAAc;AAAA,QAC3D;AAAA,MAAA;AAGF,UAAI,UAAU,cAAc,KAAK,iBAAiB,GAAG,OAAO,MAAM,GAAG;AACnE,cAAM,QAAQ,KAAK,IAAI,GAAG,OAAO,IAAI;AACrC,cAAM,IAAI,QAAQ,CAAC,YAAY,WAAW,SAAS,KAAK,CAAC;AACzD,eAAO,KAAK;AAAA,UACV;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA,UAAU;AAAA,QACZ;AAAA,MAAA;AAGI,YAAA;AAAA,IAAA;AAAA,EACR;AAEJ;"}