{"version":3,"file":"RelationBuilder.es.js","sources":["../../src/mutation/RelationBuilder.ts"],"sourcesContent":["import type {\n   AttachRelationDefinition,\n   DetachRelationDefinition,\n   SyncRelationDefinition,\n   ToggleRelationDefinition,\n   ValidCreateNestedRelation,\n   ValidUpdateNestedRelation,\n   CreateRelationOperation,\n   UpdateRelationOperation\n} from \"@/mutation/types/mutation\";\nimport type { IRelationBuilder } from \"@/mutation/interface/IRelationBuilder\";\n\nexport class RelationBuilder implements IRelationBuilder {\n   private defineRelationDefinition(result: Record<string, unknown>): void {\n      Object.defineProperty(result, '__relationDefinition', {\n         value: true,\n         enumerable: false,\n         writable: false,\n         configurable: true\n      });\n   }\n\n   private extractNestedRelations<T extends Record<string, unknown>>(\n      attributes: T\n   ): {\n      normalAttributes: Record<string, unknown>,\n      nestedRelations: Record<string, unknown>;\n   } {\n      const normalAttributes: Record<string, unknown> = {};\n      const nestedRelations: Record<string, unknown> = {};\n\n      for (const [key, value] of Object.entries(attributes)) {\n         if (value && typeof value === 'object' && 'operation' in value) {\n            nestedRelations[key] = value;\n         } else {\n            normalAttributes[key] = value;\n         }\n      }\n\n      return { normalAttributes, nestedRelations };\n   }\n\n   private addGetters(\n      relationDefinition: Record<string, unknown>,\n      normalAttributes: Record<string, unknown>\n   ): void {\n      for (const key of Object.keys(normalAttributes)) {\n         Object.defineProperty(relationDefinition, key, {\n            get() {\n               return normalAttributes[key];\n            },\n            enumerable: true\n         });\n      }\n   }\n\n   public createRelation<T extends Record<string, unknown>, RelationKeys extends keyof T = never>(\n      attributes: T,\n      relations?: Record<RelationKeys, ValidCreateNestedRelation<unknown>>\n   ): T & CreateRelationOperation<T> & {\n      relations?: Record<RelationKeys, ValidCreateNestedRelation<unknown>>;\n   } {\n      const { normalAttributes, nestedRelations: initialNestedRelations } = this.extractNestedRelations(attributes);\n      const nestedRelations = relations\n         ? { ...initialNestedRelations, ...relations }\n         : initialNestedRelations;\n\n      const relationDefinition = {\n         operation: \"create\" as const,\n         attributes: normalAttributes as T,\n         ...(Object.keys(nestedRelations).length > 0 ? { relations: nestedRelations } : {})\n      } as T & CreateRelationOperation<T> & {\n         relations?: Record<RelationKeys, ValidCreateNestedRelation<unknown>>;\n      };\n\n      this.defineRelationDefinition(relationDefinition);\n      this.addGetters(relationDefinition, normalAttributes);\n\n      return relationDefinition;\n   }\n\n   public updateRelation<T extends Record<string, unknown>, RelationKeys extends keyof T = never>(\n      key: string | number,\n      attributes: T,\n      relations?: Record<RelationKeys, ValidUpdateNestedRelation<unknown>>\n   ): T & UpdateRelationOperation<T> & {\n      operation: \"update\";\n      relations?: Record<RelationKeys, ValidUpdateNestedRelation<unknown>>;\n   } {\n      const { normalAttributes, nestedRelations: initialNestedRelations } = this.extractNestedRelations(attributes);\n      const nestedRelations = relations\n         ? { ...initialNestedRelations, ...relations }\n         : initialNestedRelations;\n\n      const relationDefinition = {\n         operation: \"update\" as const,\n         key,\n         attributes: normalAttributes as T,\n         ...(Object.keys(nestedRelations).length > 0 ? { relations: nestedRelations } : {})\n      } as T & UpdateRelationOperation<T> & {\n         relations?: Record<RelationKeys, ValidUpdateNestedRelation<unknown>>;\n      };\n\n      this.defineRelationDefinition(relationDefinition);\n      this.addGetters(relationDefinition, normalAttributes);\n\n      return relationDefinition;\n   }\n\n   public attach(key: string | number): AttachRelationDefinition {\n      const result = {\n         operation: \"attach\" as const,\n         key\n      };\n\n      this.defineRelationDefinition(result);\n      return result;\n   }\n\n   public detach(key: string | number): DetachRelationDefinition {\n      const result = {\n         operation: \"detach\" as const,\n         key\n      };\n\n      this.defineRelationDefinition(result);\n      return result;\n   }\n\n   public sync<T>(\n      key: string | number | Array<string | number>,\n      attributes?: T,\n      pivot?: Record<string, string | number>,\n      withoutDetaching?: boolean\n   ): SyncRelationDefinition<T> {\n      const result = {\n         operation: \"sync\" as const,\n         key,\n         without_detaching: withoutDetaching,\n         ...(attributes && { attributes }),\n         ...(pivot && { pivot })\n      };\n\n      this.defineRelationDefinition(result);\n      return result;\n   }\n\n   public toggle<T>(\n      key: string | number | Array<string | number>,\n      attributes?: T,\n      pivot?: Record<string, string | number>\n   ): ToggleRelationDefinition<T> {\n      const result = {\n         operation: \"toggle\" as const,\n         key,\n         ...(attributes && { attributes }),\n         ...(pivot && { pivot })\n      };\n\n      this.defineRelationDefinition(result);\n      return result;\n   }\n}"],"names":["RelationBuilder","result","attributes","normalAttributes","nestedRelations","key","value","relationDefinition","relations","initialNestedRelations","pivot","withoutDetaching"],"mappings":"AAYO,MAAMA,EAA4C;AAAA,EAC9C,yBAAyBC,GAAuC;AAC9D,WAAA,eAAeA,GAAQ,wBAAwB;AAAA,MACnD,OAAO;AAAA,MACP,YAAY;AAAA,MACZ,UAAU;AAAA,MACV,cAAc;AAAA,IAAA,CAChB;AAAA,EAAA;AAAA,EAGI,uBACLC,GAID;AACC,UAAMC,IAA4C,CAAC,GAC7CC,IAA2C,CAAC;AAElD,eAAW,CAACC,GAAKC,CAAK,KAAK,OAAO,QAAQJ,CAAU;AACjD,MAAII,KAAS,OAAOA,KAAU,YAAY,eAAeA,IACtDF,EAAgBC,CAAG,IAAIC,IAEvBH,EAAiBE,CAAG,IAAIC;AAIvB,WAAA,EAAE,kBAAAH,GAAkB,iBAAAC,EAAgB;AAAA,EAAA;AAAA,EAGtC,WACLG,GACAJ,GACK;AACL,eAAWE,KAAO,OAAO,KAAKF,CAAgB;AACpC,aAAA,eAAeI,GAAoBF,GAAK;AAAA,QAC5C,MAAM;AACH,iBAAOF,EAAiBE,CAAG;AAAA,QAC9B;AAAA,QACA,YAAY;AAAA,MAAA,CACd;AAAA,EACJ;AAAA,EAGI,eACJH,GACAM,GAGD;AACC,UAAM,EAAE,kBAAAL,GAAkB,iBAAiBM,EAA2B,IAAA,KAAK,uBAAuBP,CAAU,GACtGE,IAAkBI,IACnB,EAAE,GAAGC,GAAwB,GAAGD,MAChCC,GAECF,IAAqB;AAAA,MACxB,WAAW;AAAA,MACX,YAAYJ;AAAA,MACZ,GAAI,OAAO,KAAKC,CAAe,EAAE,SAAS,IAAI,EAAE,WAAWA,MAAoB,CAAA;AAAA,IAClF;AAIA,gBAAK,yBAAyBG,CAAkB,GAC3C,KAAA,WAAWA,GAAoBJ,CAAgB,GAE7CI;AAAA,EAAA;AAAA,EAGH,eACJF,GACAH,GACAM,GAID;AACC,UAAM,EAAE,kBAAAL,GAAkB,iBAAiBM,EAA2B,IAAA,KAAK,uBAAuBP,CAAU,GACtGE,IAAkBI,IACnB,EAAE,GAAGC,GAAwB,GAAGD,MAChCC,GAECF,IAAqB;AAAA,MACxB,WAAW;AAAA,MACX,KAAAF;AAAA,MACA,YAAYF;AAAA,MACZ,GAAI,OAAO,KAAKC,CAAe,EAAE,SAAS,IAAI,EAAE,WAAWA,MAAoB,CAAA;AAAA,IAClF;AAIA,gBAAK,yBAAyBG,CAAkB,GAC3C,KAAA,WAAWA,GAAoBJ,CAAgB,GAE7CI;AAAA,EAAA;AAAA,EAGH,OAAOF,GAAgD;AAC3D,UAAMJ,IAAS;AAAA,MACZ,WAAW;AAAA,MACX,KAAAI;AAAA,IACH;AAEA,gBAAK,yBAAyBJ,CAAM,GAC7BA;AAAA,EAAA;AAAA,EAGH,OAAOI,GAAgD;AAC3D,UAAMJ,IAAS;AAAA,MACZ,WAAW;AAAA,MACX,KAAAI;AAAA,IACH;AAEA,gBAAK,yBAAyBJ,CAAM,GAC7BA;AAAA,EAAA;AAAA,EAGH,KACJI,GACAH,GACAQ,GACAC,GAC0B;AAC1B,UAAMV,IAAS;AAAA,MACZ,WAAW;AAAA,MACX,KAAAI;AAAA,MACA,mBAAmBM;AAAA,MACnB,GAAIT,KAAc,EAAE,YAAAA,EAAW;AAAA,MAC/B,GAAIQ,KAAS,EAAE,OAAAA,EAAM;AAAA,IACxB;AAEA,gBAAK,yBAAyBT,CAAM,GAC7BA;AAAA,EAAA;AAAA,EAGH,OACJI,GACAH,GACAQ,GAC4B;AAC5B,UAAMT,IAAS;AAAA,MACZ,WAAW;AAAA,MACX,KAAAI;AAAA,MACA,GAAIH,KAAc,EAAE,YAAAA,EAAW;AAAA,MAC/B,GAAIQ,KAAS,EAAE,OAAAA,EAAM;AAAA,IACxB;AAEA,gBAAK,yBAAyBT,CAAM,GAC7BA;AAAA,EAAA;AAEb;"}